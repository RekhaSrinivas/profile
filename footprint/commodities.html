<!DOCTYPE html>
<html>

<head>
<meta charset='utf-8'>
<title>US and State Commodities - Impact Report</title>
<link rel="shortcut icon" href="data:image/x-icon;," type="image/x-icon">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://unpkg.com/tabulator-tables@5.2.7/dist/css/tabulator.min.css" rel="stylesheet">
<script type="text/javascript" src="https://unpkg.com/tabulator-tables@5.2.7/dist/js/tabulator.min.js"></script>
<script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

<!-- <script src="../dist/useeio.min.js"></script> -->
<script src="js/useeio.js"></script>
<script src="../../team/js/print-download.js"></script>
<script type="text/javascript" src="/localsite/js/localsite.js?showheader=true&showsearch=true"></script>

<script src="js/config.js"></script>
<script>
document.addEventListener('hashChangeEvent', hashChangedUseeio, false);
function hashChangedUseeio() {
  console.log("URL hash changed");
  model = getModel();
  main();
}

function documentReady(callback) {
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", callback);
  } else {
    callback();
  }
}

let tableData = [];
async function main() {
  try {
    console.log("Starting main() via window.onload");
    
    // Compute the table data
    const q = await model.matrix('q'); // Commodity
    const sectors = await model.sectors();
    
    const notesDiv = document.getElementById("notes");
    if (notesDiv) {
      let hash = getHash();
      let notesContent = "";

      notesContent = "<br>From useeio-json/models/2020/" + getModelFolderName() + "/sectors.json<br>";

      // Only add RoUS note if state parameter exists
      if (hash && hash.state) {
        notesContent += '<div style="margin-top:20px; font-style:italic;">' +
          'Note: The "Rest of US" total varies by state because it represents the total ($36.478 trillion in 2020) minus the selected state\'s value. ' +
          'States with larger economic output will show smaller Rest of US totals, as they account for a larger portion of the national total.' +
          '</div>';
      }

      // Add source note for CO2e data
      notesContent += 'CO2e Factor data source: <a href="https://zenodo.org/records/17080881" target="_blank">SupplyChainGHGEmissionFactorsv1.4.0-rc.1.xlsx</a>';

      notesDiv.innerHTML = notesContent;
    }
    
    const indicators = await model.indicators();
    const jobsIndicator = indicators.filter(i => i.code === 'JOBS')[0];
    const ghgIndicator = indicators.filter(i => i.code === 'GHG' || i.code === 'GHGR')[0]; // Try both GHG codes
    const impacts = await model.matrix('D'); // Indicator_Sector
    
    // Load CO2e data from Excel file
    let co2eData = {};
    try {
      const response = await fetch('SupplyChainGHGEmissionFactorsv1.4.0-rc.1.xlsx');
      const arrayBuffer = await response.arrayBuffer();
      const workbook = XLSX.read(arrayBuffer, { type: 'array' });
      const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
      const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
      
      // Find header row and relevant columns
      const headerRow = jsonData.find(row => row.includes('Reference USEEIO Code') || row.includes('Supply Chain Emission Factors with Margins'));
      const headerIndex = jsonData.indexOf(headerRow);
      const useeioCodeIndex = headerRow.indexOf('Reference USEEIO Code');
      const emissionFactorIndex = headerRow.indexOf('Supply Chain Emission Factors with Margins');
      
      // Process data rows
      for (let i = headerIndex + 1; i < jsonData.length; i++) {
        const row = jsonData[i];
        if (row[useeioCodeIndex] && row[emissionFactorIndex]) {
          co2eData[row[useeioCodeIndex]] = parseFloat(row[emissionFactorIndex]);
        }
      }
    } catch (error) {
      console.warn('Could not load CO2e data from Excel file:', error);
    }
    
    tableData = sectors.map(sector => {
      const output = q.get(sector.index, 0);
      const jobs = output * impacts.get(jobsIndicator.index, sector.index);
      const ghg = ghgIndicator ? output * impacts.get(ghgIndicator.index, sector.index) : 0;
      const co2e = co2eData[sector.code] || 0;
      
      return {
        ...sector,
        output: Math.round(output),
        jobs: Math.round(jobs),
        ghg: ghg,
        co2e: co2e
      };
    });
    
    console.log("Table data loaded, length:", tableData.length);
    tableData.forEach(item => {
      item.jobsEasy = formatCell(item.jobs);
      item.outputEasy = "$" + formatCell(item.output);
      item.ghgEasy = formatCell(item.ghg);
      item.co2eEasy = formatCell(item.co2e);
    });
    
    // Compute totals only if a state is specified in the URL hash:
    let hash = getHash();
    let totalsDiv = document.getElementById("totals");
    if (hash.state) {
      let stateData = tableData.filter(row => row.location.includes(hash.state));
      let rousData = tableData.filter(row => !row.location.includes(hash.state));
      
      console.log("State rows:", stateData.length, "RoUS rows:", rousData.length);
      
      const stateTotals = stateData.reduce((acc, row) => {
        acc.output += row.output || 0;
        acc.jobs += row.jobs || 0;
        acc.ghg += row.ghg || 0;
        acc.co2e += row.co2e || 0;
        return acc;
      }, { output: 0, jobs: 0, ghg: 0, co2e: 0 });

      const rousTotals = rousData.reduce((acc, row) => {
        acc.output += row.output || 0;
        acc.jobs += row.jobs || 0;
        acc.ghg += row.ghg || 0;
        acc.co2e += row.co2e || 0;
        return acc;
      }, { output: 0, jobs: 0, ghg: 0, co2e: 0 });

      console.log("Calculated totals:", { stateTotals, rousTotals });

      if (totalsDiv) {
        totalsDiv.innerHTML = 
          `<strong>State Total:</strong> $${formatCell(stateTotals.output)}, ${formatCell(stateTotals.jobs)} jobs, <span style="white-space:nowrap">${formatCell(stateTotals.ghg)} Metric Tons (Mt) of Greenhouse Gases (GHG)</span>, <span style="white-space:nowrap">${formatCell(stateTotals.co2e)} Carbon Dioxide equivalent (CO2e)</span>.<br>` +
          `<strong>Rest of US:</strong> $${formatCell(rousTotals.output)}, ${formatCell(rousTotals.jobs)} jobs, <span style="white-space:nowrap">${formatCell(rousTotals.ghg)} Metric Tons (Mt) of Greenhouse Gases (GHG)</span>, <span style="white-space:nowrap">${formatCell(rousTotals.co2e)} Carbon Dioxide equivalent (CO2e)</span>.`;
      }
    } else {
      // Calculate US total when no state is selected
      const usTotals = tableData.reduce((acc, row) => {
        acc.output += row.output || 0;
        acc.jobs += row.jobs || 0;
        acc.ghg += row.ghg || 0;
        acc.co2e += row.co2e || 0;
        return acc;
      }, { output: 0, jobs: 0, ghg: 0, co2e: 0 });

      console.log("Calculated US totals:", usTotals);

      if (totalsDiv) {
        totalsDiv.innerHTML = 
          `<strong>US Total:</strong> $${formatCell(usTotals.output)}, ${formatCell(usTotals.jobs)} jobs, <span style="white-space:nowrap">${formatCell(usTotals.ghg)} Metric Tons (Mt) of Greenhouse Gases (GHG)</span>, <span style="white-space:nowrap">${formatCell(usTotals.co2e)} Carbon Dioxide equivalent (CO2e)</span>.`;
      }
    }
    
    // Now initialize the main table with the tableData
    displayTable(getCurrentLocale(), getCurrentNumberFormat());
    
  } catch (error) {
    console.error("Error in main():", error.stack);
  }
}

window.onload = function() {
  main();
};

var table
function displayTable(locale, formatType) {
  let hash = getHash();
  //You can also pass #index=0 from commodities.html to sector_profile.html
  //But we are not passing index as it may change over time
  const columns = [
    { 
      title: "Commodity", 
      field: "name", 
      formatter: function(cell, formatterParams) {
        const sector = cell.getRow().getData();
        let stateCode = '';
        // Not using since RoUS also needs state= in URL to get the state model.
        //if (sector.location.includes('-')) {
        //  stateCode = sector.location.split('-')[1];
        //}
        if (hash.state) {
          stateCode = hash.state
        }
        const demandHash = `demand=${sector.code}/${sector.location}`;
        const stateParam = stateCode ? `&state=${stateCode}` : '';
        const indexHash = `index=${sector.index}`; // legacy support for old links
        return `<a href="sector_profile.html#${demandHash}${stateParam}">${sector.name}</a>`;
      }
    },
    { 
      title: "Location", 
      field: "location", 
      hozAlign: "right", 
      width: 100 
    },
    {
      title: "Output",
      field:
        formatType === "simple"
          ? "outputEasy"
          : formatType === "full"
          ? "output"
          : formatType === "scientific"
          ? "output"
          : "N/A",
      hozAlign: "right",
      maxWidth: "115px",
      formatter: function (cell, formatterParams) {
        var value = cell.getValue();

        if (formatType === "full") {
          return new Intl.NumberFormat(navigator.language).format(value);
        } else if (formatType === "scientific") {
          let scientificValue = Number(value).toExponential(1);
          let parts = scientificValue.split("e");
          let base = parts[0];
          let exponent = parseInt(parts[1]);
          if (exponent === 0) {
            return base;
          }
          return `${base}&times;10<sup>${exponent}</sup>`;
        }
        return value;
      },
      headerSortTristate: false,
      headerSortStartingDir: "desc",
      sorter:
        formatType === "simple"
          ? function (a, b, aRow, bRow, column, dir, sorterParams) {
              let aOutput = aRow.getData().output;
              let bOutput = bRow.getData().output;
              return aOutput - bOutput;
            }
          : undefined,
    },
    {
      title: "Jobs",
      field: formatType === "simple" ? "jobsEasy" : "jobs",
      hozAlign: "right", 
      maxWidth: "100px",
      formatter: function (cell, formatterParams) {
        var value = cell.getValue();
        if (formatType === "full") {
          return new Intl.NumberFormat(locale).format(value);
        } else if (formatType === "scientific") {
          let scientificValue = Number(value).toExponential(1);
          let parts = scientificValue.split("e");
          let base = parts[0];
          let exponent = parseInt(parts[1]);
          if (exponent === 0) {
            return base;
          }
          return `${base}&times;10<sup>${exponent}</sup>`;
        }
        return value;
      },
      headerSortTristate: false,
      headerSortStartingDir: "desc",
      sorter:
        formatType === "simple"
          ? function (a, b, aRow, bRow, column, dir, sorterParams) {
              let aJobs = aRow.getData().jobs;
              let bJobs = bRow.getData().jobs;
              return aJobs - bJobs;
            }
          : undefined,
    },
    {
      title: "GHG",
      field: formatType === "simple" ? "ghgEasy" : "ghg",
      hozAlign: "right", 
      maxWidth: "120px",
      formatter: function (cell, formatterParams) {
        var value = cell.getValue();
        if (formatType === "full") {
          return new Intl.NumberFormat(locale).format(value);
        } else if (formatType === "scientific") {
          let scientificValue = Number(value).toExponential(1);
          let parts = scientificValue.split("e");
          let base = parts[0];
          let exponent = parseInt(parts[1]);
          if (exponent === 0) {
            return base;
          }
          return `${base}&times;10<sup>${exponent}</sup>`;
        }
        return value;
      },
      headerSortTristate: false,
      headerSortStartingDir: "desc",
      sorter:
        formatType === "simple"
          ? function (a, b, aRow, bRow, column, dir, sorterParams) {
              let aGhg = aRow.getData().ghg;
              let bGhg = bRow.getData().ghg;
              return aGhg - bGhg;
            }
          : undefined,
    }
  ];

  // Add CO2e column only when viewing US data (no state specified)
  if (!hash.state) {
    columns.push({
      title: "CO2e",
      field: formatType === "simple" ? "co2eEasy" : "co2e", 
      hozAlign: "right",
      maxWidth: "110px",
      formatter: function (cell, formatterParams) {
        var value = cell.getValue();
        if (formatType === "full") {
          return new Intl.NumberFormat(locale).format(value);
        } else if (formatType === "scientific") {
          let scientificValue = Number(value).toExponential(1);
          let parts = scientificValue.split("e");
          let base = parts[0];
          let exponent = parseInt(parts[1]);
          if (exponent === 0) {
            return base;
          }
          return `${base}&times;10<sup>${exponent}</sup>`;
        }
        return value;
      },
      headerSortTristate: false,
      headerSortStartingDir: "desc",
      sorter:
        formatType === "simple"
          ? function (a, b, aRow, bRow, column, dir, sorterParams) {
              let aCo2e = aRow.getData().co2e;
              let bCo2e = bRow.getData().co2e;
              return aCo2e - bCo2e;
            }
          : undefined,
    });
  }

  table = new Tabulator("#table", {
    height: 500,
    data: tableData,
    layout: "fitColumns",
    columns: columns
  });
  
  // Add print/download icons to commodities page
  if (typeof PrintDownloadWidget !== 'undefined') {
    const options = {
      showMap: false,
      filename: 'commodities'
    };
    
    PrintDownloadWidget.addPrintDownloadIcons(
      'commodities',
      '#topControls',
      tableData,
      options
    );
  }
}

// Update the table with the selected locale
function updateTable(locale) {

    table.updateColumnDefinition("output", {
        formatter: function(cell, formatterParams) {
            var value = cell.getValue();
            return new Intl.NumberFormat(locale, { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0  }).format(value);
        }
    });

    table.redraw();
}

</script>

<style>
  .summary-card {
    padding: 15px;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    min-width: 200px;
  }
  .summary-card h4 {
    margin: 0 0 10px 0;
  }
</style>

</head>

<body>
<!-- <select id="number-format-select"></select> -->
<div class="contentpadding">

  <div id="topControls" style="float:right">
    <div style="margin-bottom: 10px; float:right"><select id="number-format-select"></select></div>
    <div style="margin-bottom: 10px; float:right"><select id="locale-select"></select></div>
  </div>

  <div style="margin-bottom:10px">
    <a id="footprintLink" href="../state/" >US State Reports</a>
  </div>
  <div id="relocatedStateMenu"></div>

  <div id="totals" style="margin:10px 0; font-size:1.1em;"></div>

  <div id="table" style="clear:both"></div>

  <div id="notes" style="clear:both; margin-top:20px;">
  </div>

<br>
State models are summary models based on <a href="../../useeio-json/">annual data</a>.<br>
Whereas the US model is based on the detail <a href="https://apps.bea.gov/iTable/?reqid=150&step=2&isuri=1&categories=gdpxind&_gl=1*1a9wl1g*_ga*OTY2NTkyODEwLjE3MzQwMzk5MzI.*_ga_J4698JNNFT*MTc0NDkwNDg4Mi40My4xLjE3NDQ5MDQ4ODUuNTcuMC4w#eyJhcHBpZCI6MTUwLCJzdGVwcyI6WzEsMiwzLDNdLCJkYXRhIjpbWyJjYXRlZ29yaWVzIiwiR2RweEluZCJdLFsiVGFibGVfTGlzdCIsIjE1Il0sWyJTY2FsZSIsIi05Il0sWyJGaXJzdF9ZZWFyIiwiMjAxMiJdLFsiTGFzdF9ZZWFyIiwiMjAyMCJdLFsiUm93cyIsWyIyMlIiLCJJSSIsIlBWVCIsIjExIiwiMTExQ0EiLCIxMTNGRiIsIjIxIiwiMjExIiwiMjEyIiwiMjEzIiwiMjIiLCIyMyIsIjMxRyIsIjMzREciLCIzMjEiLCIzMjciLCIzMzEiLCIzMzIiLCIzMzMiLCIzMzQiLCIzMzUiLCIzMzYxTVYiLCIzMzY0T1QiLCIzMzciLCIzMzkiLCIzMU5EIiwiMzExRlQiLCIzMTNUVCIsIjMxNUFMIiwiMzIyIiwiMzIzIiwiMzI0IiwiMzI1IiwiMzI2IiwiNDIiLCI0NFJUIiwiNDQxIiwiNDQ1IiwiNDUyIiwiNEEwIiwiNDhUVyIsIjQ4MSIsIjQ4MiIsIjQ4MyIsIjQ4NCIsIjQ4NSIsIjQ4NiIsIjQ4N09TIiwiNDkzIiwiNTEiLCI1MTEiLCI1MTIiLCI1MTMiLCI1MTQiLCJGSVJFIiwiNTIiLCI1MjFDSSIsIjUyMyIsIjUyNCIsIjUyNSIsIjUzIiwiNTMxIiwiSFMiLCJPUkUiLCI1MzJSTCIsIlBST0YiLCI1NCIsIjU0MTEiLCI1NDE1IiwiNTQxMk9QIiwiNTUiLCI1NiIsIjU2MSIsIjU2MiIsIjYiLCI2MSIsIjYyIiwiNjIxIiwiNjIyIiwiNjIzIiwiNjI0IiwiNyIsIjcxIiwiNzExQVMiLCI3MTMiLCI3MiIsIjcyMSIsIjcyMiIsIjgxIiwiRyIsIkdGIiwiR0ZHIiwiR0ZHRCIsIkdGR04iLCJHRkUiLCJHU0wiLCJHU0xHIiwiR1NMRSIsIiIsIlBHT09EIiwiUFNFUlYiLCJJQ1QiXV0sWyJTZXJpZXMiLCJBIl0sWyJDb2x1bW5zIixbIjIwMjAiXV1dfQ==">benchmark year of 2012</a>

</div>

<script>
// Populate the locale dropdown
var localeSelect = document.getElementById("locale-select");
var locales = ["en-US", "fr-FR", "de-DE", "es-ES", "it-IT", "ja-JP", "ko-KR", "zh-CN"];

locales.forEach(locale => {
    let option = document.createElement("option");
    option.value = locale;
    option.textContent = locale;
    localeSelect.appendChild(option);
});

// Populate the number format dropdown
let numberFormatToggle = document.getElementById("number-format-select");
let formats = ["simple", "full", "scientific"];
formats.forEach(format => {
    let option = document.createElement("option");
    option.value = format;
    option.textContent = format;
    numberFormatToggle.appendChild(option);
});

// Apply cached preferences and add listeners after population
document.addEventListener('DOMContentLoaded', function() {
    // Apply cached preferences from config.js
    applyCachedPreferences();
    
    // Add commodities-specific event listeners
    localeSelect.addEventListener("change", function() {
        updateTable(this.value);
    });

    numberFormatToggle.addEventListener("change", function() {
        displayTable(getCurrentLocale(), this.value);
    });

    // Trigger initial display with cached values
    displayTable(getCurrentLocale(), getCurrentNumberFormat());
});

</script>

</body>
</html>